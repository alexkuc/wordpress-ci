version: v1.0
name: WordPress CI Pipeline

auto_cancel:
  running:
    when: "branch != 'master'"

fail_fast:
  stop:
    when: "branch != 'master'"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 10

blocks:

  - name: Setup
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: SemaphoreCI config
          commands:
            - echo 'SemaphoreCI config is fine if this message is printed!'
        - name: Composer (--dev)
          env_vars:
            - name: CI_COMPOSER
              value: '1'
          commands:
            - .semaphore/composer/cache-restore.sh
            - scripts/code/setup.sh
            - .semaphore/composer/cache-store.sh
        - name: Composer (--no-dev)
          env_vars:
            - name: CI_COMPOSER
              value: '1'
            - name: CI_COMPOSER_NO_DEV
              value: '1'
          commands:
            - .semaphore/composer/cache-restore.sh
            - scripts/code/setup.sh
            - .semaphore/composer/cache-store.sh

  - name: Linters
    dependencies: ['Setup']
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: ShellCheck
          commands:
            - scripts/code/shellcheck.sh
        - name: phplint
          commands:
            - .semaphore/composer/cache-restore.sh
            - scripts/code/phplint.sh

  - name: PHP Tests
    dependencies: ['Setup']
    task:
      prologue:
        commands:
          - checkout
          - .semaphore/composer/cache-restore.sh
          - sudo chmod -R 777 .
          - scripts/host/up.sh
      epilogue:
        on_fail:
          commands:
            - artifact push job test/tests/_output/
      jobs:
        - name: acceptance
          commands:
            - scripts/code/test.sh acceptance
        - name: functional
          commands:
            - scripts/code/test.sh functional
        - name: wpunit
          commands:
            - scripts/code/test.sh wpunit
        - name: unit
          commands:
            - scripts/code/test.sh unit

  - name: Assets (Theme)
    dependencies: ['Setup']
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: Minifier (JS)
          commands:
            # TODO: complete JS minifier
            - echo '...'
        - name: Minifier (CSS)
          commands:
            # TODO: complete CSS minifier
            - echo '...'

  - name: Deploy
    dependencies: ['Linters', 'PHP Tests', 'Assets (Theme)']
    # TODO: uncomment
    # skip:
    #   when: "branch != 'master'"
    task:
      prologue:
        commands:
          - checkout
          - export CI_COMPOSER_NO_DEV='1'
          - .semaphore/composer/cache-restore.sh
          - sudo chmod -R 777 .
      jobs:
        - name: Theme
          commands:
            # TODO: complete deploy stage
            - echo '...'
