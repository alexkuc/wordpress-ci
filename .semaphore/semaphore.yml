version: v1.0
name: WordPress CI Pipeline

auto_cancel:
  running:
    when: "branch != 'master'"

fail_fast:
  stop:
    when: "branch != 'master'"

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 5

blocks:

  - name: Linters
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: ShellCheck
          commands:
            - scripts/code/shellcheck.sh
        - name: phplint
          commands:
            - .semaphore/cache.sh restore
            - scripts/code/setup.sh
            - .semaphore/cache.sh store
            - scripts/code/phplint.sh

  - name: Tests
    dependencies: ['Linters']
    task:
      epilogue:
        on_fail:
          commands:
            - artifact push job wp-browser/tests/_output/
      jobs:
        - name: PHP
          commands:
            - checkout
            - scripts/host/up.sh
            - .semaphore/cache.sh restore
            - scripts/code/setup.sh
            - .semaphore/fix-permissions.sh
            - scripts/code/test.sh

  - name: Assets
    dependencies: ['Linters']
    task:
      env_vars:
        - name: COMPOSER_PROD
          value: '1'
      jobs:
        - name: Compile
          commands:
            - checkout
            # do NOT restore cache here as we are using
            # production depedencies (--no-dev), see
            # scripts/code/composer.sh for details
            - scripts/code/setup.sh
            - artifact push workflow my-theme
            - artifact push workflow my-plugin

  - name: Deploy
    # skip:
    #   when: "branch != 'master'"
    dependencies: ['Assets', 'Tests']
    task:
      prologue:
        commands:
          - checkout
          - sudo chmod -R 777 .
      jobs:
        - name: Theme
          commands:
            - artifact pull workflow my-theme --force
            - scripts/code/deploy.sh my-theme
            - artifact push project my-theme/my-theme.zip --force
        - name: Plugin
          commands:
            - artifact pull workflow my-plugin --force
            - scripts/code/deploy.sh my-plugin
            - artifact push project my-plugin/my-plugin.zip --force
