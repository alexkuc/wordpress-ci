version: v1.0
name: WordPress CI Pipeline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 5

blocks:

  - name: ShellCheck
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: shellcheck
            image: alexkuc/shellcheck:semaphoreci
      jobs:
        - name: Lint
          commands:
            - checkout
            - find . -type f -name '*.sh' | wc -l
            - find . -type f -name '*.sh' | xargs shellcheck --external-sources

  - name: phplint
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: composer
            image: composer
      jobs:
        - name: Lint
          commands:
            - checkout
            - scripts/code/setup.sh
            - scripts/code/phplint.sh

  - name: WP-Browser
    dependencies: ['ShellCheck', 'phplint']
    task:
      jobs:
        - name: Tests
          commands:
            - checkout
            - export COMPOSER_JSON="$(checksum ./wp-browser/composer.lock)"
            - export COMPOSER_LOCK="$(checksum ./wp-browser/composer.json)"
            - scripts/host/up.sh
            - cache restore "composer-$COMPOSER_LOCK-$COMPOSER_JSON"
            - scripts/code/setup.sh
            - .semaphore/fix-permissions.sh
            - scripts/code/test.sh

      epilogue:
        on_pass:
          commands:
            - cache store "composer-$COMPOSER_LOCK-$COMPOSER_JSON" wp-browser/vendor

        on_fail:
          commands:
            - artifact push job wp-browser/tests/_output/
